<% dias_da_semana = dias_da_semana || Date.current.all_week %>
<% id = "#{dom_id profissional}_agenda" %>
<% pode_deletar = pode_deletar || false %>

<div id="<%= id %>">
  <table>
    <caption>
      Agenda
      <%== "<br>" * 2 %>
      <%= hx_form get: agenda_profissional_path, target: "##{id}", select: "##{id}" do %>
        <input type="date" id="start_date" name="start_date" value="<%= dias_da_semana.first %>">
        <input type="submit" value="Verificar semana" style="font-size:1rem;">
      <% end %>
    </caption>
    <thead>
      <tr>
        <th width="10%"></th>
        <% dias_da_semana.each do |dia| %>
          <th>
            <%= SemanaDia.find(dia.wday).nome[..2] %>
            <br>
            <%= render_data_brasil dia %>
          </th>
        <% end %>
      </tr>
    </thead>
    <tbody>
      <tr>
        <th>
          Agenda disponível
        </th>
        <% dias_da_semana.each do |dia| %>
          <td>
              <% agenda = profissional.agenda(dia)[dia] %>
              <% agenda.each do |horario| %>
                <% unless horario[:de_folga] %>
                  <% disponivel = horario[:folga].blank? && horario[:atendendo].blank? %>
                  <% color = disponivel ? "green"  : "red" %>
                  <% style = {
                    "border-radius" => "1em",
                    "padding" => "1em",
                    "text-align" => "center",
                    "color" => "var(--doc-#{color}-light)",
                    "background-color" => "var(--doc-#{color}-dark)",
                    "cursor" => "default",
                    "position" => "relative",
                  } %>

                <p>
                <div style="<%= style.map { |k,v| "#{k}:#{v}"}.join(";") %>">
                <b><u><%= render_hora_brasil horario[:horario] %></b></u>
                  <%= disponivel ? "Disponível" : "Indisponível" %>
                  <% if horario[:reservado].count > 0 %>
                    <div class="horario-reservado">
                      Reservado
                      <div class="agenda-modal-acompanhamento">
                        <% acomp = horario[:reservado].first %>
                        <%= acomp.pessoa.nome_abreviado %>
                        <%= acomp.pessoa.idade_anos&.to_s&.insert(0, "[")&.insert(-1, "a]") %>
                        <%= acomp.pessoa_responsavel&.nome_abreviado&.insert(0, " (resp.: ")&.insert(-1, ")") %>
                      </div>
                    </div>
                  <% end %>
                <%# <%= "<span style=\"background-color:orange;color:black;padding:.1em;position:absolute;border-radius:.3em;top:-.5em;right:.1em;\">Reservado</span>".html_safe if horario[:reservado].count > 0 %1> %>
                </div>
                </p>
                <% end %>
              <% end %>
            <%# <%= profissional.agenda(dia)[dia] %1> %>
          </td>
        <% end %>
      </tr>
    </tbody>
  </table>
</div>
